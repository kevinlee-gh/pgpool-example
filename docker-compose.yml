name: pgpool

x-node-template: &node-template
  build: ./database
  user: postgres
  command:
    - postgres
    - -cconfig_file=/configs/postgres.conf
    - -chba_file=/configs/pg_hba.conf
  volumes:
    - /var/lib/postgresql/data/pgdata
    - ./database/configs:/configs:ro
  environment:
    PGDATA: /var/lib/postgresql/data/pgdata
    
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres123
  healthcheck:
    test: 'pg_isready -U postgres --dbname=postgres'
    interval: 10s
    timeout: 5s
    retries: 5
  deploy:
    resources:
      limits:
        # cpus: '0.01'
        memory: 2G

services:
  ansible:
    build: ./ansible
    volumes:
      - ./ansible:/workspace
    working_dir: /workspace
    entrypoint:
      - tail
      - -f
      - /dev/null

  client:
    build: ./client
    entrypoint:
      - tail
      - -f
      - /dev/null
    
  node-1:
    <<: *node-template
    volumes:
      - node-1:/var/lib/postgresql/data
      - ./database/configs:/configs:ro
  
  node-2:
    <<: *node-template
    volumes:
      - node-2:/var/lib/postgresql/data
      - ./database/configs:/configs:ro

  node-3:
    <<: *node-template
    volumes:
      - node-3:/var/lib/postgresql/data
      - ./database/configs:/configs:ro

  nginx:
    build: ./nginx
    ports:
      - "6433:5433"   # Postgres node 1
      - "6434:5434"   # Postgres node 2
      - "6435:5435"   # Postgres node 3
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - node-1
      - node-2
      - node-3

volumes:
  node-1:
  node-2:
  node-3:
